.. _service_configuration:

**************************
Настройка сервиса IPTV/OTT
**************************

Для настройки сервиса доступны две панели администрирования - служебная и основная.
Служебная панель необходима для настройки общих и базовых сущностей, а также редактирования любых объектов.

В основной панели настраивается непосредственно сам сервис IPTV/OTT для конкретного оператора
(:ref:`Добавление клиента <client-creation>`).

+-------------------+------------------------------------------------+
| Служебная         | http://smarty.example.com/admin                |
+-------------------+------------------------------------------------+
| Основная          | http://smarty.example.com                      |
+-------------------+------------------------------------------------+

Служебная панель администрирования доступна только для супер-администратора (общий администратор системы).

.. _initial-setup:

Первичная настройка системы
===========================

.. _client-creation:

Добавление клиента
------------------

Для функционирования системы необходимо, чтобы был создан хотя бы один клиент. Под клиентом подразумевается оператор
услуг или проект.

Создать клиента необходимо в служебной панели администрирования по ссылке: http://smarty.example.com/admin/client/

Описание полей:

+-------------------------------------+------------------------------------------------------------------------------+
| Имя клиента                         | Название оператора или проекта                                               |
+-------------------------------------+------------------------------------------------------------------------------+
| E-Mail                              | E-mail для отправки системных сообщений                                      |
+-------------------------------------+------------------------------------------------------------------------------+
| Поддомен                            | Имя поддомена для настройки порталов provider.example.com                    |
+-------------------------------------+------------------------------------------------------------------------------+
| Адрес сайта                         | Адрес сайта сервиса                                                          |
+-------------------------------------+------------------------------------------------------------------------------+
| API key                             | Ключ API для подключения абонентских устройств                               |
+-------------------------------------+------------------------------------------------------------------------------+
| Billing API key                     | Ключ API для скрипта интеграции с внешним биллингом                          |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступен архив                      | Разрешить оператору доступ к сервису "Архив"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступна видеотека                  | Разрешить оператору доступ к сервису "Видеотека"                             |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступно радио                      | Разрешить оператору доступ к сервису "Радио"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны игры                       | Разрешить оператору доступ к сервису "Игры"                                  |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступен мониторинг                 | Разрешить оператору доступ к разделу "Мониторинг"                            |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступно ТВ-Middleware              | Разрешить оператору доступ к сервису "IPTV"                                  |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны отчеты                     | Разрешить оператору доступ к модулю "Отчеты"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны внешние приложения         | Разрешить оператору доступ к сервису "Приложения"                            |
+-------------------------------------+------------------------------------------------------------------------------+
| Валюта по-умолчанию                 | Валюта, которая будет выбрана при оплате услуг абонентом                     |
+-------------------------------------+------------------------------------------------------------------------------+
| Способ оплаты по-умолчанию          | Способ оплаты, который будет выбран при оплате услуг абонентом               |
+-------------------------------------+------------------------------------------------------------------------------+
| Максимально дней пробного просмотра | Ограничение для запросов к API на создание аккаунтов                         |
+-------------------------------------+------------------------------------------------------------------------------+
| Маска номера договора               | Маска формирования номера договора (:ref:`Подробнее <template-engine-docs>`) |
+-------------------------------------+------------------------------------------------------------------------------+
| Маска номера счета                  | Маска формирования номера счета (:ref:`Подробнее <template-engine-docs>`)    |
+-------------------------------------+------------------------------------------------------------------------------+
| Механизм GeoIP                      | Используемый механизм геолокации                                             |
+-------------------------------------+------------------------------------------------------------------------------+

.. _mwportals-and-devices-linking:

Привязка абонентского устройства к клиенту
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для привязки приложения абонента к конкретному клиенту или оператору используется ключ API (api_key) и ID клиента
(client_id). Эти параметры необходимо прописать в файле настроек client.js при настройке портала, а также при сборке
нативных клиентов под устройства. Подробнее см. в разделе :ref:`Приложения для абонентских устройств <apps_for_devices>`

API-ключ следует генерировать через утилиту pwgen с ключом ``-s`` длиной не менее ``64`` символов, например:
::
    pwgen -s 64


.. _playdevice-template-creation:

Добавление шаблонов порталов
----------------------------

В служебной панели администрирования добавить установленные шаблоны порталов:
http://smarty.example.com/admin/tvmiddleware/playdevicetemplate/

Названия (пути) стандартных шаблонов: ``classic`` ``impuls`` ``iridium`` ``focus`` ``orbit``

Подробнее см. в разделе :ref:`Приложения для абонентских устройств <apps_for_devices>`

.. _playdevice-creation:

Добавление поддерживаемых устройств
-----------------------------------

В служебной панели администрирования добавить поддерживаемые типы устройств:
http://smarty.example.com/admin/tvmiddleware/playdevice/

Описание полей:

+--------------------+-----------------------------------------------------------------+
| Название           | Название типа устройства                                        |
+--------------------+-----------------------------------------------------------------+
| Имеет портал       | Использует ли устройство портал, или работает напрямую с API    |
+--------------------+-----------------------------------------------------------------+
| Системное название | Системное название типа устройства, возможные значения см. ниже |
+--------------------+-----------------------------------------------------------------+

Поддерживаемые типы устройств (системные названия): ``android`` ``android_stb`` ``dune`` ``eltex`` ``lg_netcast``
``lg_webos`` ``mag`` ``pc`` ``sagemcom`` ``samsung_smart_tv`` ``tizen_tv`` ``ios`` ``wrt`` ``amino``

.. _playdevice-assigning-to-client:

Подключение разрешенных оператору типов устройств
-------------------------------------------------

В служебной панели администрирования добавить разрешенные типы устройств для каждого оператора:
http://smarty.example.com/admin/tvmiddleware/clientplaydevice/

.. _epg-setup:

Настройка EPG и иконок телеканалов
----------------------------------

В системе существует базовое понятие EPG Channel - это телеканал с прикрепленными иконками и программой передач.
Затем, при создании сетки каналов оператора каждому каналу ставится в соответствие один из базовых каналов.
Таким образом, за телеканалами оператора закрепляется иконка и телепрограмма (EPG).

Телепрограмма может быть получена из разных источников, которые настраиваются в служебной панели администрирования:
http://smarty.example.com/admin/tvmiddleware/epgsource/

Описание полей:

+---------------------+----------------------------------------------------------------------------------------------+
| Название источника  | Название для отображения                                                                     |
+---------------------+----------------------------------------------------------------------------------------------+
| Имя модуля парсера  | Имя должно соответствовать имени файла с классом парсера в папке /tvmiddleware/epg_parsers/  |
+---------------------+----------------------------------------------------------------------------------------------+
| Маска URL           | Предоставляется поставщиком EPG                                                              |
+---------------------+----------------------------------------------------------------------------------------------+

Существующие парсеры:

+------------+------------------------------------------------------------+
| Имя модуля | Поставщик EPG                                              |
+------------+------------------------------------------------------------+
| yandex     | http://tv.yandex.ru, бесплатный доступ (парсер с сайта)    |
+------------+------------------------------------------------------------+
| teleguide  | http://teleguide.info, бесплатный доступ (парсер с сайта)  |
+------------+------------------------------------------------------------+
| epgservice | http://epgservice.ru, платный доступ, формат XMLTV         |
+------------+------------------------------------------------------------+

Настройка EPG-каналов осуществляется в служебной панели администрирования:
http://smarty.example.com/admin/tvmiddleware/epgchannel/

Описание полей:

+----------------------------+------------------------------------------------------------------------------+
| Название                   | Название канала                                                              |
+----------------------------+------------------------------------------------------------------------------+
| URL иконки                 | Путь к иконке, абсолютный или относительный, начиная с /tvmiddleware/media/  |
+----------------------------+------------------------------------------------------------------------------+
| Источник EPG               | Имя источника                                                                |
+----------------------------+------------------------------------------------------------------------------+
| ID канала в источнике EPG  | ID канала в сервисе источника                                                |
+----------------------------+------------------------------------------------------------------------------+
| Номер для сортировки       | Позиция в общем списке, используется для автоматической сортировки оператора |
+----------------------------+------------------------------------------------------------------------------+
| Сдвиг в часах              | Сдвиг программы в часах относительно UTC+0                                   |
+----------------------------+------------------------------------------------------------------------------+

Иконки каналов по-умолчанию находятся по адресу /tvmiddleware/media/img/logo/default/

.. _custom-epg-parser:

Добавление нового типа парсера
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для добавления собственного парсера EPG необходимо создать модуль на Python в папке /tvmiddleware/epg_parsers/,
который должен содержать класс EpgParser, наследуемый от EpgParserBase и реализующий все его методы, а затем создать
запись в EPG Source.

.. _multiprovider:

Мультипровайдер
===============

"Мультипровайдер" - это возможность подключения нескольких проектов или операторов в рамках одной инсталляции системы.
Для каждого проекта при этом будет использоваться независимый набор настроек, абонентская база, параметры устройств,
услуг и т.д.

Добавление операторов осуществляется аналогично тому, как это описано в разделе первичной настройки
:ref:`Добавление клиента <client-creation>`.

.. _builtin-billing:

Встроенный биллинг
==================

Описание режимов работы
-----------------------

.. _billing-activation-deactivation-dates-mode:

I. По датам активации и деактивации (предоплатная модель)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для каждого аккаунта может быть задана дата активации и дата деактивации. Когда наступает дата активации
аккаунт автоматически активируется и может быть авторизован в системе и получить доступ к просмотру.
Когда наступает дата деактивации, аккаунт деактивируется. Биллинг самостоятельно не устанавливает эти даты,
поэтому такой вариант биллинга является ручным или полуавтоматическим.

Варианты использования:

1. Даты устанавливаются администратором / оператором абонентского отдела
2. Даты устанавливаются внешней биллинговой системой через :ref:`Billing API <billing-api>`
3. Для предоставления первичного доступа к сервису после регистрации, или раздачи тестовых аккаунтов.
   В таком случае используется специальное поле *"количество дней активации"*, которое предустанавливается для нового аккаунта.
   Если это поле задано, то после первой авторизации такого аккаунта (разрешается авторизоваться неактивным аккаунтом)
   он сразу активируется, при этом устанавливается дата активации (текущая дата) и дата деактивации (дата активации + число дней тестового доступа).
   Затем по наступлении даты деактивации аккаунт отключается, как описано выше.

.. _billing-auto-mode:

II. Автоматический (предоплатная модель)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Ежемесячная подписка.
   Логика работы повторяет режим I, кроме следующих исключений:
   а) в момент наступления даты деактивации происходит попытка списания средств и продления аккаунта, а также устанавливается дата продления, равная текущей дате;
   б) если наступает дата, равная дате последнего продления + календарный месяц, то происходит попытка списания средств и продления аккаунта.
2. Ежегодная подписка - не реализовано во встроенном биллинге, требуется использование внешнего биллинга.
3. Другое (система скидок, платежи за несколько месяцев) - не реализовано во встроенном биллинге, требуется использование внешнего биллинга.

.. _billing-charging-mechanism:

Механизм списания средств и продления
+++++++++++++++++++++++++++++++++++++

Если на счете абонента есть необходимая сумма денег для оплаты всех подключенных тарифных пакетов и опций на очередной месяц,
то происходит списание этих средств и аккаунт не деактивируется.
Устанавливается дата продления, равная текущей дате (необходима для расчета следующего списания).

Если средств недостаточно, то аккаунт деактивируется.
В момент списания средств создается транзакция с отрицательной суммой операции.

.. _billing-payment-mechanism:

Механизм оплаты
+++++++++++++++

Оплата возможна через ручное создание транзакции в биллинге, через внешний биллинг,
через оплату в личном кабинете (оплата разными способами через шлюз WalletOne, оплата кредитной картой, Paypal).
После подтверждения транзакции если аккаунт абонента неактивен, то происходит попытка списания средств и продления аккаунта,
а если он активен - то простое зачисления средств на личный счет в системе.
В момент оплаты создается транзакция с положительной суммой операции.

.. _billing-disabled-mode:

III. Встроенный биллинг отключен
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если не установлена ни дата активации, ни дата деактивации, ни дата продления (не используется ни I режим, ни II),
то биллинг для аккаунта считается отключенным.
Такой аккаунт может быть постоянно активированным, или управляться внешней биллинговой системой без задействования встроенного биллинга.
См. :ref:`Варианты взаимодействия с внешней биллинговой системой <billing-integration-scenarios>`.

.. _billing-general-points:

Общие особенности
-----------------

У одного абонента может быть несколько аккаунтов - в этом случае стомость услуг для абонента увеличивается на число аккаунтов на всех этапах обработки биллингом.

.. _billing-tariffs-features:

Возможности тарификации
-----------------------

Тарифный план представляет собой группу объединенных в него услуг, например - телеканалов, интерактивных функций, фильмов и т.д.

Набор подключенных тарифных планов абонента определяет набор доступных для него услуг, при этом возможно пересечение услуг в разных тарифных планах.

Тарифный план может не содержать ни одной услуг, однако обладать определенными опциями и разрешениями - см. далее, в таком случае тарифный план считается тарифной опцией.

.. _billing-tariffs-types:

Типы тарифных планов
~~~~~~~~~~~~~~~~~~~~

1. Помесячная оплата - тарифный план рассчитывается биллингом в рамках ежемесячной подписки.

2. Ежегодная оплата - во встроенном биллинге не реализовано.

3. Скрытый - тарифный план не участвует в расчетах и невидим для абонента.

.. _billing-multiabonement:

Мультиабонемент
~~~~~~~~~~~~~~~

Для тарифного плана возможно включить опцию *Мультиабонемент*, указав количество возможных одновременных сессий.
Среди подключенных у абонента тарифных планов с опцией *Мультиабонемент* будет выбран тот, где число одновременных сессий максимально,
и именно такое количество сессий будет разрешено для одновременного использования абонентом на разных устройствах,
однако в пределах одного IP-адреса (используется для пакетов типа "Семейный").

.. _billing-basic-tariff:

Признак базового тарифа
~~~~~~~~~~~~~~~~~~~~~~~

Поле *"Приоритет тарифа среди базовых тарифов"* означает принадлежность тарифа к Базовому и его вес среди них.
Например, может быть создано несколько базовых тарифов, при этом тариф с наибольшим приоритетом будет устанавливаться абонентам по-умолчанию.

Абонент может выбрать только один из базовых тарифов при регистрации и в личном кабинете.

Тариф, не являющийся базовым, считается дополнительным.
Дополнительные тарифы могут быть подключены только дополнительно к одному из базовых, и не могут быть подключены отдельно от него.

.. _billing-debtors-tariffs:

Доступность тарифа для неактивных аккаунтов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Специальная опция тарифа *"доступен для неактивных аккаунтов"* позволяет создать тарифные планы с набором бесплатных услуг,
доступных абонентам, которые были отключены по причине неоплаты, или другой причине.

Таким образом, можно создать набор телеканалов или дополнительных сервисов, которые будут доступны неактивным абонентам.

Для аккаунтов, у абонентов которых есть подключенные тарифные планы с такой опцией,
разрешается авторизация в системе даже будучи неактивными, однако им выдается ограниченный данными тарифными планами набор услуг.

Это может быть использовано, например, для бесплатной трансляции каналов 1 и 2 мультиплекса.

.. _documents-rendering:

Формирование документов
-----------------------

.. _documents-template-creation:

Создание шаблонов документов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. _template-engine-docs:

Документация по работе шаблонизатора: http://djbook.ru/rel1.7/#the-template-layer

.. _smarty-admin-guide:

Руководство по работе в панели администратора
=============================================

.. _smarty-admin-guide-intro:

Общие сведения об административном интерфейсе
---------------------------------------------

Условно интерфейс можно разделить на две области: панель управления и область данных.

Панель управления имеет следующие элементы:

* Ссылки на разделы настроек — обеспечивает удобную навигацию по интерфейсу.
* Выбор текущего оператора в рамках функции :ref:`Мультипровайдер <multiprovider>`.
* Выбор языка — кнопки переключения языка интерфейса (русский и английский).
* Имя пользователя — показывает имя текущего пользователя, а так же позволяет выйти из административного интерфейса, если при нажатии на имя пользователя в открывшемся списке выбрать "Выход".

Область данных может выглядеть по-разному в зависимости от текущего раздела.

.. _smarty-admin-guide-interface-desc:

Описание интерфейса
-------------------

Все настройки административного интерфейса тематически сгруппированы в меню на панели управления.
При выборе любого пункта выводится список настраиваемых сущностей. Если в списке нет ни одного пункта,
то вместо списка выводится сообщение о том, что они не найдены.

Для списков доступна сортировка, но только по одному столбцу. При этом доступные для сортировки столбцы имеют нижнее
точечное подчеркивание своего наименования.

.. image:: img/admin-guide-sort-columns.png

Чтобы отсортировать список нужно просто нажать на название столбца. Первый клик отсортирует список по возрастанию,
второй — по убыванию, дальнейшие клики будут чередовать эти два способа сортировки. При этом сортировка по возрастанию
обозначается стрелкой вверх рядом с наименованием столбца, а сортировка по убыванию — стрелкой вниз.

.. image:: img/admin-guide-sort-asc.png

Для некоторых данных используется специальная колонка *Порядок сортировки*.
Она сортирует элементы не только в административном интерфейсе, но и определяет порядок отображения элементов
в интерфейсе на устройстве абонентов. В этой колонке каждому элементу списка соответствует свой значок стрелки.
В зависимости от того, вверх или вниз направлена стрелка, при нажатии на нее элемент уйдет вверх или вниз по списку
соответственно.

.. image:: img/admin-guide-sort-field.png

Если список элементов большой, то он разбивается на страницы. На одной странице обычно размещается 25 записей,
но можно выбрать другое значение — 10, 50, 100 или 250, за эту функцию отвечает раскрывающийся список внизу страницы.

.. image:: img/admin-guide-number-of-rows.png

При выборе нового значения текущая страница обновляется, и в зависимости от получившегося количества страниц,
отображается либо та же по счету страница, на которой была произведена смена значений, либо первая ближайшая к ней.
Навигация между страницами осуществляется с помощью навигационной панели с номерами страниц. На панели располагается
10 кнопок с номерами страниц, остальные кнопки позволяют перемещаться между страницами. Так кнопки **<** и **>**
ведут на предыдущую и следующую страницы соответственно. А кнопки **<<** и **>>** загружают первую и последнюю страницы
соответственно.

.. image:: img/admin-guide-pagination.png

Почти во всех разделах доступен поиск. В большинстве случаев он представлен в виде одного текстового поля над списком
элементов с правой стороны.

.. image:: img/admin-guide-search.png

Для разных разделов доступен поиск по разным данным, поэтому в описании каждого из них будет описано по каким полям
реализован поиск. Однако, практически во всех разделах доступен поиск по ID записи, поисковый запрос в этом случае
должен начинаться с символа ``#``, то есть быть вида ``#ID``.
Для возврата от результатов поиска к полному списку служит кнопка **Сбросить**.

Практически для всех настроек доступно добавление/удаление пунктов. Эту функцию обеспечивают кнопки **Добавить**,
**Изменить** и **Удалить выбранные** над списком.

.. image:: img/admin-guide-manage-buttons.png

При этом кнопки **Изменить** и **Удалить выбранные** становятся активными, только после выбора хотя бы одного пункта
списка.

Для удаления сущности достаточно нажать на кнопку **Удалить выбранные**.
После нажатия кнопки **Изменить** открывается страница редактирования, где можно менять значения параметров.

.. image:: img/admin-guide-edit-form.png

Кнопка **Сохранить изменения** сохраняет внесенные правки. Кнопка **Вернуться к списку** не сохраняя внесенных правок,
просто перемещает пользователя к списку настраиваемых сущностей.

В некоторых разделах доступна сводная статистика активности, например в аккаунтах клиентов.

.. image:: img/admin-guide-active-status.png

Синим цветом в таких таблицах обозначается общее количество записей. Зеленым обозначается количество записей, у которых
в настройках выбрано: *Активен* или *Включен*, либо их статус *Online*, соответственно красный цвет — количество
записей, у которых не включены значения *Активен* или *Включен*. Серый цвет — количество записей со статусом *Offline*.

.. _smarty-admin-guide-index:

Обзор основных разделов
-----------------------

Панель администора позволяет управлять настройками таких компонентов как:

* Абонентская база
* Тарифные планы и набор услуг
* Телеканалы
* Телепрограмма (EPG)
* Радиостанции
* Каталог видеотеки
* Каталог приложений и игр
* Видеосервисы (Live, VOD, NPVR и др.)
* Устройства просмотра

Для удобства настройки сгруппированы в меню на главной панели и разделены на категории:

* Общее
* Видеостриминг
* Биллинг
* Услуги
* Клиенты

Чтобы начать работать с настройками следует выбрать необходимый пункт в выпадающем списке интересующей категории.
Каждая настройка представляет собой список, элементы которого можно добавлять/удалять, а так же менять значения их параметров, что позволяет
настраивать различные компоненты.

.. _smarty-admin-guide-main:

Раздел: Общее
-------------

.. _smarty-admin-guide-main-device-configuration:

Настройки STB и виджетов
~~~~~~~~~~~~~~~~~~~~~~~~

Этот раздел содержит список устройств для просмотра сервиса IPTV (приставки Set-Top Box, Smart TV, мобильные устройства,
компьютер и др.), которые поддерживаются оператором
(см. :ref:`Подключение разрешенных оператору типов устройств<playdevice-assigning-to-client>`).

Здесь указываются базовые настройки для взаимодействия устройств с сервисом.

Для редактирования настроек устройства можно использовать кнопку **Настройки**, либо нажать на название устройства.

На странице настроек можно задать следующие параметры:

Логотип для главного меню
    Изображение с логотипом оператора, которое будет отображаться в главном меню приложения.

Логотип для страницы авторизации
    -//- для страницы авторизации.

Логотип для стартовой страницы
    -//- для страницы загрузки приложения.

Шаблон оформления
    Шаблон оформления абонентского интерфейса. Может быть переопределен настройками аккаунта.

URL на внешний CSS-файл
    Дает возможность задать URL на внешний файл с CSS-стилями если есть необходимость подкорректировать стили
    оформления интерфейса.

Отображать меню '...'
    Позволяет выбрать меню для отображения в интерфейсе, отметив желаемые галочками.

Включить сбор статистических
    Активирует отправку данных телесмотрения с приложения на сервер статистики данных
    (необходима настройка модуля Reports на сервере с MongoDB для хранения данных).

Включить автообновление данных
    Активирует автоматический перезапрос редко обновляемых данных с сервера без без перезагрузки устройства
    перезагрузки устройства. Отключение этой опции повышает производительность.

Текст на странице входа
    Текст приветствия, отображаемый на странице авторизации в приложении.

Переопределить API URL
    В настоящий момент не используется.

Поиск для этого раздела не предусмотрен.

.. _smarty-admin-guide-main-site-widgets:

Виджеты для сайта
~~~~~~~~~~~~~~~~~

В этом разделе настраиваются виджеты для интеграции сайта с сервисом IPTV. Подробнее о механизме
:ref:`встраивания модулей в сайт <widgets-api>`.

Доступны следующие типы виджетов:

* *Channel list* - список телеканалов с группировкой по тарифным планам и возможностью поиска.
* *Registration* - страница регистрации с помощью e-mail и СМС.
* *Account page* - личный кабинет абонента, из которого доступно подключение/отключение тарифных планов, оплата, редактирования профиля и др.
* *EPG program* - телепрограмма на все подключенные телеканалы.

Настройки виджетов:

Тип
    Тип виджета.

Hostname
    URL сайта. Поле используется для защиты виджетов от встранивания в чужой сайт.

URL на внешний CSS-файл
    Адрес файла со стилями виджета. По-умолчанию, стили отсутствуют.

Включено
    Флаг, позволяющий включить или отключить определенный виджет.

Для виджета типа *Registration*:

Personal data law URL
    Ссылка на страницу с текстом закона о защите данных абонента.

Public offer URL
    Ссылка на страницу публичной оферты.

Для виджета типа *Account page*:

Relative account page URL
    Ссылка на страницу личного кабинета на сайте оператора, где встраивается виджет. Используется для редиректа.

Поиск доступен по полю *Hostname*.

.. _smarty-admin-guide-main-user-access:

Настройка прав пользователей
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В этом разделе администратору доступно редактирование прав других администраторов или модераторов сервиса
для ограничения их доступа к тем или иным разделам или функциональности.

Добавление новых пользователей производится в служебной панели администрирования по ссылке:
http://smarty.example.com/admin/users/user/.

Права доступа разделены по группам согласно категориям разделов в панели администратора. Детальные права на
выполнение тех или иных действий с данными состоят из:

* *Can view ...* - имеет доступ к просмотру информации
* *Can create ...* - имеет доступ к созданию элементов
* *Can edit ...* - имеет доступ к редактированию
* *Can delete ...* - имеет доступ к удалению

Поиск доступен по имени пользователя.

.. _smarty-admin-guide-videostreaming:

Раздел: Видеостриминг
---------------------

.. _smarty-admin-guide-videostreaming-data-centers:

Дата-центры
~~~~~~~~~~~

Под дата-центром подразумевается либо физический узел размещения группы серверов, либо виртуальная группа
видео-сервисов. Используется для объединения сервисов и дальнейшей маршрутизации на основании предпочтительного
географического либо иного отношения аккаунтов к тем или иным сервисам.

Настройки дата-центра включают в себя:

Название
    Наименование дата-центра, лучше всего писать его служебное имя.

Расположение
    Физическое или виртуальное местоположение дата-центра.

Включено
    Галочка напротив данного пункта указывает на то, что дата-центр используется для предоставления услуг и будет
    участвовать в маршрутизации.

Поиск реализован по полям: *Название*.


.. _smarty-admin-guide-videostreaming-cas:

CAS-серверы
~~~~~~~~~~~

CAS-сервер это сервер в IPTV-сети оператора, на котором установлено программное решение, позволяющее ограничить доступ
к шифруемому контенту и выдавать ключи для его расшифровки на устройствах абонентов.

CAS-сервер привязывается к стриминг-сервисам (в соответствие с настройками самого CAS) и к устройствам абонентов,
которые его поддерживают.

При наличии привязанного к сервису CAS-сервера Middleware передает устройству абонента не только список каналов и
ссылку на конкретный видеопоток, но и дополнительно информацию о привязанном к нему CAS-сервере.
Эти данные необходимы для обеспечения работы устройства с CAS-сервером.
Поскольку некоторые устройства могут поддерживать только определенные CAS, для покрытия всех устройств обычно
используется несколько CAS.

Для того чтобы добавить CAS-сервер в личном кабинете необходимо внести следующие данные:

Тип
    Программное решение, обеспечивающее CAS.

IP-адрес
    IP-адрес сервера CAS.

Порт
    Порт сервера CAS.

Поддерживаемые устройства
    Список устройств, которые будут работать с выбранной CAS.

Поиск предусмотрен только по *ID*, поисковый запрос должен быть вида ``#ID``.

.. _smarty-admin-guide-videostreaming-video-services:

Видео-сервисы
~~~~~~~~~~~~~

Видео-сервисы представляют собой серверы, осуществляющие вещание и обработку видеопотоков.
Набор настроек различается в зависимости от типа выбранного видеосервиса, однако параметры в блоках
*Основные параметры* являются общими для всех.

Название
    Наименование сервиса. Например, имя сервера или конфигурации по ТУ оператора.

Дата-центр
    Дата-центр или группа, к которой относится данный сервис.

Тип
    Тип видеосервиса.

Тип маршрутизации
    Выбор одного из двух типов маршрутизации:

    * Основана на маске URI - при этом способе URL на видеопоток или файл формируется по маске.
    * Python-скрипт - маршрутизация задается скриптом (см. пример далее).

    Под маршрутизацией подразумевается вычисление URL видеопотока, которое происходит в момент обращения устройства
    к соответствующему контенту.

Маска URI / Код скрипта
    Маска URL видеопотока или динамический скрипт. Обратите внимание на возможность применения переменных.

Включено
    Флаг позволяет отключить или включить определенные сервисы из маршрутизации.

IP-адрес сервиса / Порт сервиса / Секретная фраза
    Набор настроек для доступа к API сервиса. Необходимо только при использовании видео-серверов ПО Microimpuls.
    Через API осуществляется настройка сервиса из Middleware, а также авторизация потоков по одноразовым токенам.

Включить управление и авторизацию через API
    Флаг позволяет отключить или включить взаимодействие с сервисом Microimpuls через API.

Включить авторизацию nginx secure_link
    При выборе этой настройки появляется возможность использования дополнительной авторизации ссылок на видеопоток
    с помощью модуля secure_link HTTP-сервера nginx.

Секретная фраза
    Фраза которая будет использована для формирования секретного хэша в ссылке на видеопоток для модуля secure_link.

Время действия
    Время действия в секундах сформированной ссылки доступа к видеопотоку (в некоторых случаях следует указывать время
    равным максимальному непрерывному просмотру потока, например 24 часа (86400)).

CAS-сервисы
    Если используется шифрование видеопотока, то необходимо выбрать используемые CAS-сервисы.

Для типа HTTP Streamer:

Сдвиг вещания на
    Время сдвига вещания в часах, в котором вещает сервис. Используется для реализации функции Timeshift - вещание
    эфира со сдвигом для часовых поясов, отличных от часого пояса телеканала. Значение в этом поле используется для
    маршрутизации, в связке с соответствующими настройками аккаунта
    (см. в :ref:`Аккаунты <smarty-admin-guide-customers-accounts>`). Видео-сервис для вещания со сдвигом
    конфигурируется отдельно (более подробно читайте в документации соответствующего ПО).

Для типа HTTP Archive Streamer и NPVR:

Сколько дней записывать
    Глубина записи телеканала в днях для сервиса MicroPVR. По прошествию этого количества дней происходит ротация
    записи.

Длительность каждой записи
    Размер одного непрерывного файла записи, в часах. Обычно рекомендуется использовать суточную запись, т.е. 24 часа.

Начинать новую запись в
    Время в сутках, в которое предпочтительно осуществлять разрыв файла записи и начинать новый. Во время разрыва при
    непрерывном просмотре архивной трансляции будет кратковременный обрыв трансляции.

Записывать в директорию
    Абсолютный путь директории на сервере, куда будет осуществляться запись. Поддиректория для конкретного канала
    создается сервисом MicroPVR автоматически.

Тип хранилища
    Тип используемого хранилища для записи определяет приоритет обращения к записям исходя из скорости доступа - так,
    самым быстрым видом хранилища является Memory, затем SSD, затем HDD. Используется для одновременной записи
    наиболее популярных телеканалов на несколько носителей (конфигурируется несколькими видео-сервисами). При этом
    возможно определять разную глубину и время записи на разный тип памяти.

Продолжительность жизни записи
    Для сервисов NPVR определяет максимальное время жизни записи в секундах, после прошествия которого она будет
    удалена с сервера и недоступна абоненту.

Для выбора доступны следующие типы потоковых сервисов:

* *HTTP Streamer* - Unicast-стример Live-потоков. Подходит для HTTP MPEG-TS Streaming, HLS и других Unicast-форматов,
  базирующихся или схожих с протоколом HTTP.
* *HTTP Archive Streamer* - Unicast-стример нелинейного ТВ из записи. Подходит для сервисов Catch-Up.
* *HTTP VOD Streamer* - Unicast-стример фильмов VOD.
* *UDP Streamer* - UDP Unicast/Multicast-стример.
* *NPVR* - Unicast-стример нелинейных записей для сервиса NPVR.
* *Vidimax* - используется для подключения онлайн-кинотеатра Vidimax. По поводу настройки данного сервиса обратитесь,
  пожалуйста, к своему менеджеру проекта или техническому представителю Microimpuls.

Поиск реализован по полям: *Название*.


Динамическая и статическая маршрутизация
++++++++++++++++++++++++++++++++++++++++

Если для телеканала, фильма или другой единицы контента заданы активные видео-сервисы и не задан прямой URI потока, то
будет использована динамическая маршрутизация. В момент обращения абонентской приставки к соответствующему контенту
осуществляется поиск одного из подключенных видео-сервисов на основании типа контента, подключенных тарифных планов,
а также доступности и нагруженности сервиса. Затем, исходя из настроек видео-сервиса, формируется URL контента, по
маске либо после вычисления скрипта.

При статической маршрутизации URL контента генерируется при формировании плейлиста. Такой тип маршрутизации может
быть использован для потоков без авторизации, Multicast-потоков для IPTV, либо внешних Unicast-потоков партнеров.

Динамическая маршрутизация, задаваемая скриптом
+++++++++++++++++++++++++++++++++++++++++++++++

Скрипт позволяет создать нестандартную логику маршрутизации. Используемый язык - Python. В результате работы скрипта
должна быть определена переменная ``uri``, содержащая URL видеопотока.

Пример скрипта:
::
    def get_random_proxy(datacenter):
	    if datacenter == 4:
		    proxies = [
			    {
    				'ip': '1.1.1.1', 'port': 8181,
	    			'key': 'DrRSwkrMudmsYb0K'
    			},
	    		{
    				'ip': '2.2.2.2', 'port': 8181,
    				'key': 'DrRSwkrMudmsYb0K'
    			},
    			{
    				'ip': '3.3.3.3', 'port': 8181,
    				'key': 'DrRSwkrMudmsYb0K'
    			}
    		]
    	else:
    		return 0
    	return random.choice(proxies)

    uri = 'http://1.2.3.4:8080/%s/?s=DeZcC2A0OkjLwlBb' % prefix

    proxy = get_random_proxy(adid)
    if proxy:
    	uri = 'http://%s:%d/%s/%s' % (proxy['ip'], proxy['port'], proxy['key'], uri.replace('http://', ''))

Выше приведен пример скрипта, в котором URL видеопотока задается сначала по маске, а затем, если у аккаунта
задан определенный дата-центр (id = 4 в примере), то для него случайным образом выбирается один из прокси-серверов,
после чего URL заменяется на прокси.

.. _smarty-admin-guide-videostreaming-maintenance:

Технические работы
~~~~~~~~~~~~~~~~~~

Технические работы используются для частичного ограничения доступа к сервису когда это необходимо.
Например, в заданный временной период, пока проводятся технические работы либо произошла авария, абонентам может быть
недоступен просмотр записанных программ.

В настройках используются данные:

Описание
    Описание технических работ.

Время начала
    Дата и время начала технических работ.

Время окончания
    Дата и время окончания технических работ.

Сервис недоступен
    Флаг делает сервис недоступным для абонентов, если не отметить этот пункт, то вне зависимости от указанного
    времени начала работ сервис не заблокируется.

Работы завершены
    Флаг необходимо отметить после завершения работ, это вернет абонентам доступ к сервису вне зависимости от
    указанного времени окончания работ.

Каналы
    Телеканалы, которые затрагиваются техническими работами (Ctrl + клик левой кнопкой мыши позволяет выбрать
    несколько каналов).

Видео-сервисы
    Видео-сервисы, которые затрагиваются техническими работами.

Поиск реализован по полям: *Описание*.

Биллинг
-------

Тарифные планы
~~~~~~~~~~~~~~

Раздел позволяет управлять списком тарифных планов и их настройками.
См. :ref:`Возможности тарификации <billing-tariffs-features>`.

Для настройки доступны следующие параметры:

Название
    Наименование тарифного плана.

Тип
    см. :ref:`Типы тарифных планов <billing-tariffs-types>`.

Стоимость
    Размер абонентской платы по тарифу в выбранной валюте.

Валюта
    Выбор валюты тарифного плана.

Мультиабонемент
    Выбор максимального количества одновременных сессий для одного аккаунта, то есть возможность использовать сервис
    IPTV сразу с нескольких устройств, при условии что у всех устройств один и тот же внешний IP-адрес.
    См. :ref:`Описание функции Мультиабонемент <billing-multiabonement>`.

Приоритет тарифа среди базовых тарифов
    См. :ref:`Признак базового тарифа <billing-basic-tariff>`.

Включено
    Флаг для временного отключения или подключения тарифного плана в системе.

Подключаемый по умолчанию
    Тариф с такой пометкой будет автоматически подключаться каждому вновь добавленному абоненту, однако в дальнейшем
    оператор или абонент может самостоятельно отключить его в личном кабинете.

Обязательный
    Тариф, который так же автоматически подключается каждому абоненту, но абонент не может самостоятельно отключить его
    в личном кабинете, использовать эту настройку стоит только в случае наличия одного базового тарифа.

Показывать каналы из тарифа на сайте
    При включении этого флага тарифный план и соответствующие телеканалы будут отображаться в виджете для сайта
    *Channel list* (см. :ref:`Настройка виджетов для сайта <smarty-admin-guide-main-site-widgets>`).

Доступен для неактивных аккаунтов
    См. :ref:`Доступность тарифа для неактивных аккаунтов <billing-debtors-tariffs>`.

Видео-сервисы
    Подключение потоковых сервисов, которые будут доступны абонентам при подключении данного тарифного плана.

Гео-привязка
    При включенном механизме геолокации (см. :ref:`Настройка геолокации <geo-settings>`) позволяет ограничить
    города и страны, в которых данный тарифный план будет доступным. Левый список содержит выбранные страны и города.
    Используйте строку поиска для быстрого выбора.

Поиск реализован по полям: *Название*.

Документы
~~~~~~~~~

Финансовые операции
~~~~~~~~~~~~~~~~~~~

Услуги
------

ТВ: Категории
~~~~~~~~~~~~~

ТВ: Каналы
~~~~~~~~~~

ТВ: Телепрограмма
~~~~~~~~~~~~~~~~~

Видеотека: Жанры
~~~~~~~~~~~~~~~~

Видеотека: Фильмы
~~~~~~~~~~~~~~~~~

Радиостанции
~~~~~~~~~~~~

Рекламные ролики
~~~~~~~~~~~~~~~~

Рекламные блоки
~~~~~~~~~~~~~~~

Каталог приложений
~~~~~~~~~~~~~~~~~~

Каталог игр
~~~~~~~~~~~

Клиенты
-------

Клиенты
~~~~~~~

.. _smarty-admin-guide-customers-accounts:

Аккаунты
~~~~~~~~

Устройства
~~~~~~~~~~

Сообщения
~~~~~~~~~

Дилеры
~~~~~~

Массовая установка аккаунтам дата-центра
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~





