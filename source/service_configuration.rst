.. _service_configuration:

**************************
Настройка сервиса IPTV/OTT
**************************

Для настройки сервиса доступны две панели администрирования - служебная и основная.
Служебная панель необходима для настройки общих и базовых сущностей, а также редактирования любых объектов.

В основной панели настраивается непосредственно сам сервис IPTV/OTT для конкретного оператора
(:ref:`Добавление клиента <client-creation>`).

+-------------------+------------------------------------------------+
| Служебная         | http://smarty.example.com/admin                |
+-------------------+------------------------------------------------+
| Основная          | http://smarty.example.com                      |
+-------------------+------------------------------------------------+

Служебная панель администрирования доступна только для супер-администратора (общий администратор системы).

.. _initial-setup:

Первичная настройка системы
===========================

.. _client-creation:

Добавление клиента
------------------

Для функционирования системы необходимо, чтобы был создан хотя бы один клиент. Под клиентом подразумевается оператор
услуг или проект.

Создать клиента необходимо в служебной панели администрирования по ссылке: http://smarty.example.com/admin/client/

Описание полей:

+-------------------------------------+------------------------------------------------------------------------------+
| Имя клиента                         | Название оператора или проекта                                               |
+-------------------------------------+------------------------------------------------------------------------------+
| E-Mail                              | E-mail для отправки системных сообщений                                      |
+-------------------------------------+------------------------------------------------------------------------------+
| Поддомен                            | Имя поддомена для настройки порталов provider.example.com                    |
+-------------------------------------+------------------------------------------------------------------------------+
| Адрес сайта                         | Адрес сайта сервиса                                                          |
+-------------------------------------+------------------------------------------------------------------------------+
| API key                             | Ключ API для подключения абонентских устройств                               |
+-------------------------------------+------------------------------------------------------------------------------+
| Billing API key                     | Ключ API для скрипта интеграции с внешним биллингом                          |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступен архив                      | Разрешить оператору доступ к сервису "Архив"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступна видеотека                  | Разрешить оператору доступ к сервису "Видеотека"                             |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступно радио                      | Разрешить оператору доступ к сервису "Радио"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны игры                       | Разрешить оператору доступ к сервису "Игры"                                  |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступен мониторинг                 | Разрешить оператору доступ к разделу "Мониторинг"                            |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступно ТВ-Middleware              | Разрешить оператору доступ к сервису "IPTV"                                  |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны отчеты                     | Разрешить оператору доступ к модулю "Отчеты"                                 |
+-------------------------------------+------------------------------------------------------------------------------+
| Доступны внешние приложения         | Разрешить оператору доступ к сервису "Приложения"                            |
+-------------------------------------+------------------------------------------------------------------------------+
| Валюта по-умолчанию                 | Валюта, которая будет выбрана при оплате услуг абонентом                     |
+-------------------------------------+------------------------------------------------------------------------------+
| Способ оплаты по-умолчанию          | Способ оплаты, который будет выбран при оплате услуг абонентом               |
+-------------------------------------+------------------------------------------------------------------------------+
| Максимально дней пробного просмотра | Ограничение для запросов к API на создание аккаунтов                         |
+-------------------------------------+------------------------------------------------------------------------------+
| Маска номера договора               | Маска формирования номера договора (:ref:`Подробнее <template-engine-docs>`) |
+-------------------------------------+------------------------------------------------------------------------------+
| Маска номера счета                  | Маска формирования номера счета (:ref:`Подробнее <template-engine-docs>`)    |
+-------------------------------------+------------------------------------------------------------------------------+
| Механизм GeoIP                      | Используемый механизм геолокации                                             |
+-------------------------------------+------------------------------------------------------------------------------+

.. _mwportals-and-devices-linking:

Привязка абонентского устройства к клиенту
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для привязки приложения абонента к конкретному клиенту или оператору используется ключ API (api_key) и ID клиента
(client_id). Эти параметры необходимо прописать в файле настроек client.js при настройке портала, а также при сборке
нативных клиентов под устройства. Подробнее см. в разделе :ref:`Приложения для абонентских устройств <apps_for_devices>`

API-ключ следует генерировать через утилиту pwgen с ключом ``-s`` длиной не менее ``64`` символов, например:
::
    pwgen -s 64


.. _playdevice-template-creation:

Добавление шаблонов порталов
----------------------------

В служебной панели администрирования добавить установленные шаблоны порталов:
http://smarty.example.com/admin/tvmiddleware/playdevicetemplate/

Названия (пути) стандартных шаблонов: ``classic`` ``impuls`` ``iridium`` ``focus`` ``orbit``

Подробнее см. в разделе :ref:`Приложения для абонентских устройств <apps_for_devices>`

.. _playdevice-creation:

Добавление поддерживаемых устройств
-----------------------------------

В служебной панели администрирования добавить поддерживаемые типы устройств:
http://smarty.example.com/admin/tvmiddleware/playdevice/

Описание полей:

+--------------------+-----------------------------------------------------------------+
| Название           | Название типа устройства                                        |
+--------------------+-----------------------------------------------------------------+
| Имеет портал       | Использует ли устройство портал, или работает напрямую с API    |
+--------------------+-----------------------------------------------------------------+
| Системное название | Системное название типа устройства, возможные значения см. ниже |
+--------------------+-----------------------------------------------------------------+

Поддерживаемые типы устройств (системные названия): ``android`` ``android_stb`` ``dune`` ``eltex`` ``lg_netcast``
``lg_webos`` ``mag`` ``pc`` ``sagemcom`` ``samsung_smart_tv`` ``tizen_tv`` ``ios`` ``wrt`` ``amino``

.. _playdevice-assigning-to-client:

Подключение разрешенных оператору типов устройств
-------------------------------------------------

В служебной панели администрирования добавить разрешенные типы устройств для каждого оператора:
http://smarty.example.com/admin/tvmiddleware/clientplaydevice/

.. _epg-setup:

Настройка EPG и иконок телеканалов
----------------------------------

В системе существует базовое понятие EPG Channel - это телеканал с прикрепленными иконками и программой передач.
Затем, при создании сетки каналов оператора каждому каналу ставится в соответствие один из базовых каналов.
Таким образом, за телеканалами оператора закрепляется иконка и телепрограмма (EPG).

Телепрограмма может быть получена из разных источников, которые настраиваются в служебной панели администрирования:
http://smarty.example.com/admin/tvmiddleware/epgsource/

Описание полей:

+---------------------+----------------------------------------------------------------------------------------------+
| Название источника  | Название для отображения                                                                     |
+---------------------+----------------------------------------------------------------------------------------------+
| Имя модуля парсера  | Имя должно соответствовать имени файла с классом парсера в папке /tvmiddleware/epg_parsers/  |
+---------------------+----------------------------------------------------------------------------------------------+
| Маска URL           | Предоставляется поставщиком EPG                                                              |
+---------------------+----------------------------------------------------------------------------------------------+

Существующие парсеры:

+------------+------------------------------------------------------------+
| Имя модуля | Поставщик EPG                                              |
+------------+------------------------------------------------------------+
| yandex     | http://tv.yandex.ru, бесплатный доступ (парсер с сайта)    |
+------------+------------------------------------------------------------+
| teleguide  | http://teleguide.info, бесплатный доступ (парсер с сайта)  |
+------------+------------------------------------------------------------+
| epgservice | http://epgservice.ru, платный доступ, формат XMLTV         |
+------------+------------------------------------------------------------+

Настройка EPG-каналов осуществляется в служебной панели администрирования:
http://smarty.example.com/admin/tvmiddleware/epgchannel/

Описание полей:

+----------------------------+------------------------------------------------------------------------------+
| Название                   | Название канала                                                              |
+----------------------------+------------------------------------------------------------------------------+
| URL иконки                 | Путь к иконке, абсолютный или относительный, начиная с /tvmiddleware/media/  |
+----------------------------+------------------------------------------------------------------------------+
| Источник EPG               | Имя источника                                                                |
+----------------------------+------------------------------------------------------------------------------+
| ID канала в источнике EPG  | ID канала в сервисе источника                                                |
+----------------------------+------------------------------------------------------------------------------+
| Номер для сортировки       | Позиция в общем списке, используется для автоматической сортировки оператора |
+----------------------------+------------------------------------------------------------------------------+
| Сдвиг в часах              | Сдвиг программы в часах относительно UTC+0                                   |
+----------------------------+------------------------------------------------------------------------------+

Иконки каналов по-умолчанию находятся по адресу /tvmiddleware/media/img/logo/default/

.. _custom-epg-parser:

Добавление нового типа парсера
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для добавления собственного парсера EPG необходимо создать модуль на Python в папке /tvmiddleware/epg_parsers/,
который должен содержать класс EpgParser, наследуемый от EpgParserBase и реализующий все его методы, а затем создать
запись в EPG Source.

.. _multiprovider:

Мультипровайдер
===============

"Мультипровайдер" - это возможность подключения нескольких проектов или операторов в рамках одной инсталляции системы.
Для каждого проекта при этом будет использоваться независимый набор настроек, абонентская база, параметры устройств,
услуг и т.д.

Добавление операторов осуществляется аналогично тому, как это описано в разделе первичной настройки
:ref:`Добавление клиента <client-creation>`.

.. _builtin-billing:

Встроенный биллинг
==================

Описание режимов работы
-----------------------

I. По датам активации и деактивации (предоплатная модель)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для каждого аккаунта может быть задана дата активации и дата деактивации. Когда наступает дата активации
аккаунт автоматически активируется и может быть авторизован в системе и получить доступ к просмотру.
Когда наступает дата деактивации, аккаунт деактивируется. Биллинг самостоятельно не устанавливает эти даты,
поэтому такой вариант биллинга является ручным или полуавтоматическим.

Варианты использования:

1. Даты устанавливаются администратором / оператором абонентского отдела
2. Даты устанавливаются внешней биллинговой системой через :ref:`Billing API <billing-api>`
3. Для предоставления первичного доступа к сервису после регистрации, или раздачи тестовых аккаунтов.
   В таком случае используется специальное поле *"количество дней активации"*, которое предустанавливается для нового аккаунта.
   Если это поле задано, то после первой авторизации такого аккаунта (разрешается авторизоваться неактивным аккаунтом)
   он сразу активируется, при этом устанавливается дата активации (текущая дата) и дата деактивации (дата активации + число дней тестового доступа).
   Затем по наступлении даты деактивации аккаунт отключается, как описано выше.

II. Автоматический (предоплатная модель)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Ежемесячная подписка.
   Логика работы повторяет режим I, кроме следующих исключений:
   а) в момент наступления даты деактивации происходит попытка списания средств и продления аккаунта, а также устанавливается дата продления, равная текущей дате;
   б) если наступает дата, равная дате последнего продления + календарный месяц, то происходит попытка списания средств и продления аккаунта.
2. Ежегодная подписка - не реализовано во встроенном биллинге, требуется использование внешнего биллинга.
3. Другое (система скидок, платежи за несколько месяцев) - не реализовано во встроенном биллинге, требуется использование внешнего биллинга.

Механизм списания средств и продления
+++++++++++++++++++++++++++++++++++++

Если на счете абонента есть необходимая сумма денег для оплаты всех подключенных тарифных пакетов и опций на очередной месяц,
то происходит списание этих средств и аккаунт не деактивируется.
Устанавливается дата продления, равная текущей дате (необходима для расчета следующего списания).

Если средств недостаточно, то аккаунт деактивируется.
В момент списания средств создается транзакция с отрицательной суммой операции.

Механизм оплаты
+++++++++++++++

Оплата возможна через ручное создание транзакции в биллинге, через внешний биллинг,
через оплату в личном кабинете (оплата разными способами через шлюз WalletOne, оплата кредитной картой, Paypal).
После подтверждения транзакции если аккаунт абонента неактивен, то происходит попытка списания средств и продления аккаунта,
а если он активен - то простое зачисления средств на личный счет в системе.
В момент оплаты создается транзакция с положительной суммой операции.

III. Встроенный биллинг отключен
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если не установлена ни дата активации, ни дата деактивации, ни дата продления (не используется ни I режим, ни II),
то биллинг для аккаунта считается отключенным.
Такой аккаунт может быть постоянно активированным, или управляться внешней биллинговой системой без задействования встроенного биллинга.

Общие особенности
-----------------

У одного абонента может быть несколько аккаунтов - в этом случае стомость услуг для абонента увеличивается на число аккаунтов на всех этапах обработки биллингом.

Возможности тарификации
-----------------------

Тарифный план представляет собой группу объединенных в него услуг, например - телеканалов, интерактивных функций, фильмов и т.д.

Набор подключенных тарифных планов абонента определяет набор доступных для него услуг, при этом возможно пересечение услуг в разных тарифных планах.

Тарифный план может не содержать ни одной услуг, однако обладать определенными опциями и разрешениями - см. далее, в таком случае тарифный план считается тарифной опцией.

Типы тарифных планов
~~~~~~~~~~~~~~~~~~~~

1. Помесячная оплата - тарифный план рассчитывается биллингом в рамках ежемесячной подписки.

2. Ежегодная оплата - во встроенном биллинге не реализовано.

3. Скрытый - тарифный план не участвует в расчетах и невидим для абонента.

Мультиабонемент
~~~~~~~~~~~~~~~

Для тарифного плана возможно включить опцию *Мультиабонемент*, указав количество возможных одновременных сессий.
Среди подключенных у абонента тарифных планов с опцией *Мультиабонемент* будет выбран тот, где число одновременных сессий максимально,
и именно такое количество сессий будет разрешено для одновременного использования абонентом на разных устройствах,
однако в пределах одного IP-адреса (используется для пакетов типа "Семейный").

Признак базового тарифа
~~~~~~~~~~~~~~~~~~~~~~~

Поле *"Приоритет тарифа среди базовых тарифов"* означает принадлежность тарифа к Базовому и его вес среди них.
Например, может быть создано несколько базовых тарифов, при этом тариф с наибольшим приоритетом будет устанавливаться абонентам по-умолчанию.

Абонент может выбрать только один из базовых тарифов при регистрации и в личном кабинете.

Тариф, не являющийся базовым, считается дополнительным.
Дополнительные тарифы могут быть подключены только дополнительно к одному из базовых, и не могут быть подключены отдельно от него.

Доступность тарифа для неактивных аккаунтов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Специальная опция тарифа *"доступен для неактивных аккаунтов"* позволяет создать тарифные планы с набором бесплатных услуг,
доступных абонентам, которые были отключены по причине неоплаты, или другой причине.

Таким образом, можно создать набор телеканалов или дополнительных сервисов, которые будут доступны неактивным абонентам.

Для аккаунтов, у абонентов которых есть подключенные тарифные планы с такой опцией,
разрешается авторизация в системе даже будучи неактивными, однако им выдается ограниченный данными тарифными планами набор услуг.

Это может быть использовано, например, для бесплатной трансляции каналов 1 и 2 мультиплекса.


.. _documents-rendering:

Формирование документов
-----------------------

.. _documents-template-creation:

Создание шаблонов документов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. _template-engine-docs:

Документация по работе шаблонизатора: http://djbook.ru/rel1.7/#the-template-layer

Панель администрирования smarty
===============================

Ссылка на инструкцию по панели администратора: `скачать <http://dl.micro.im/manuals/smarty/microimpuls_middleware_admin_v1.7.pdf>`_

Биллинг
-------

.. _admin-tariffs:

Тарифные планы
~~~~~~~~~~~~~~

