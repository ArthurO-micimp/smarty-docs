.. _integration:

*******************************
Интеграция с внешними системами
*******************************

.. _tvmiddleware-api:

Взаимодействие с абонентскими устройствами
==========================================

`Документация по TVMiddleware API <http://smarty.microimpuls.com/docs/tvmiddleware_api/>`_

.. _billing-api:

Интеграция с биллингом
======================

`Документация по Billing API <http://smarty.microimpuls.com/docs/billing_api/>`_

.. _billing-api-samples:

Примеры кода
------------

Библиотека на Python: https://github.com/microimpuls/smarty-billing-api-python

см. :ref:`Дополнительные инструменты <tools-and-scripts>`

.. _billing-integration-scenarios:

Основные варианты взаимодействия с биллинговой системой
-------------------------------------------------------

Существует три варианта взаимодействия внешней биллинговой системы с сервером smarty:

#. Полный - встроенный биллинг не используется, управлением подписок полностью управляет внешний биллинг.
#. Транзакционный - внешний биллинг создает финансовые транзакции в smarty, управлением подписок занимается встроенный биллинг.
#. Сокращенный - используется какая-либо часть функций из полного варианта.

Также возможно использование только встроенного биллинга - см. :ref:`Встроенный биллинг <builtin-billing>`.

.. _billing-integration-full-mode:

Полный вариант взаимодействия
+++++++++++++++++++++++++++++

* В полном варианте всё управление абонентами и их подписками осуществляется через интерфейс внешней биллинговой системы,
  а произведенные операции синхронизируются с smarty путем отправки команд через :ref:`Billing API <billing-api>`.

* Биллинг осуществляет списание/начисление средств исходя из информации, предоставляемой системой предоставления
  услуг о приобретении/потреблении той или иной услуги, а также осуществляет периодические операции над счетами,
  такие как списание абонентской платы и т.п.

* Список тарифных планов формируется на стороне smarty и на стороне внешнего биллинга, производится соответствие идентификаторов
  тарифных планов в скрипте интеграции.

* Формирование ценообразования пакетов и услуг происходит на стороне внешнего биллинга.

* Подробная информация об абонентах хранится во внешнем биллинге, в smarty достаточно хранить только лицевые счета и услуги.

* Для целей ведения внутреннего учета на стороне smarty внешний биллинг может создавать транзакции в smarty.

* Для авторизации абонентских устройств может использоваться пара абонемент-пароль, только абонемент, или только UID устройства (например, MAC-адрес).
  В качестве абонемента может выступать лицевой счет.

.. _billing-integration-full-scenarios:

Сценарии взаимодействия при полном варианте
...........................................

.. image:: img/billing-scenarios.jpg

При реализации полного варианта взаимодействия реализуются все отображенные на рисунке команды от биллинговой системы
к smarty, кроме команд с пунктирной стрелкой (они могут быть реализованы по усмотрению).

Кроме того smarty может дополнительно запрашивать у внешнего биллинга информацию о детализации платежей, начислений,
списке подключенных услуг и их стоимостей, а также проводить обещанный платеж. Эти дополнительные возможности
могут быть реализованы в интерфейсе абонента по усмотрению.

При наличии технической возможности абоненту можно также предоставить возможность проводить оплату сервиса с помощью
кредитной карты из абонентского интерфейса на своем устройстве.

.. _billing-integration-transaction-mode:

Транзакционный вариант взаимодействия
+++++++++++++++++++++++++++++++++++++

* В транзакционном варианте управление абонентами и их подписками осуществляется встроенным биллингом smarty.

* Встроенный биллинг осуществляет списание/начисление средств исходя из команд на создание/удаление транзакций из
  внешнего биллинга, панели администратора, или при ежемесячном автоматическом списании средств с виртуального счета,
  а также пополнения через встроенные средства оплаты.

* Формирование тарифных планов и их ценообразования происходит на стороне smarty.

* Подробная информация об абонентах хранится на стороне smarty.

.. _payment-api:

Платежный шлюз
==============

`Документация по Payment API <http://smarty.microimpuls.com/docs/payment_api/>`_

.. _widgets-api:

Встраивание модулей в сайт
==========================

`Документация по Site-Widgets API <http://smarty.microimpuls.com/docs/widgets_api/>`_

.. _tools-and-scripts:

Дополнительные инструменты
==========================

Скрипт миграции данных smarty между БД по client_id
  https://github.com/microimpuls/admin-tools/tree/master/smarty_migrate_tool

Скрипт миграции с OFT Middleware на Microimpuls Middleware
  https://github.com/microimpuls/admin-tools/tree/master/oft_db_migrate_tool

Скрипт миграции аккаунтов и MAC-адресов с Hydra Billing в Microimpuls Middleware
  https://github.com/microimpuls/admin-tools/tree/master/hydra_migrate

Скрипт массового создания аккаунтов через Billing API
  https://github.com/microimpuls/admin-tools/tree/master/mass_customer_creator

Другие полезные скрипты и утилиты см. в репозитории https://github.com/microimpuls/admin-tools