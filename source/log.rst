.. _log:

****************************
4. Логирование работы Smarty
****************************

4.1. Логи Smarty
================

Записи в логах имеют следующий вид: ::

    %(timestamp)% %(log level)% %(module)%:%(code line number)% %(function)%[%(pid)%.%(thread id)%] %(message text)%

Сообщение (message text) состоит из названия события и дополнительного контекста.

Пример записи в логе: ::

    Fri Mar 24 10:22:35 2017 DEBUG api:621 get[83630.Thread-3] event='some_event' 'ip'='127.0.0.1' args=['foo', 'bar']

В этом примере *some_event* - это название события, а *ip* и *args* - дополнительный контекст.

События в зависимости от типа группируются в разных файлах. По умолчанию, логи сохраняются по адресу ``/var/log/microimpuls/smarty/``.

4.1.1. smarty_main - основной лог
---------------------------------

Типы событий:

urls_initialized
++++++++++++++++

Конфигурация Smarty инициализирована.
Происходит во время старта приложения, дополнительный контекст:

* ``available_apps`` - доступные модули


События, необработанные другими логгерами
+++++++++++++++++++++++++++++++++++++++++

Происходит во время ошибки, необходимо обратиться к разработчику для решения проблемы.

Дополнительный контекст: локальные переменные функции, в которой произошла ошибка.


4.1.2. smarty_accounts_login - лог авторизации абонентов
--------------------------------------------------------

Типы событий:

login_success
+++++++++++++

Успешная авторизация, контекст:

* ``login_type`` - тип логина (мультилогин, базовое устройство, дополнительное устройство)
* ``login_method`` - метод логина (по абонементу и паролю, только по абонементу, только по UID устройства)
* ``params`` - параметры запроса


login_error
+++++++++++

Ошибка авторизации, контекст:

* ``reason`` - причина ошибки:
* * account_does_not_exist - аккаунт не существует - абонемент или пароль или device_uid неверный
* * account_is_not_active - аккаунт не активен
* * client_does_not_exist - неверный client_id или api_key
* * basic_device_sessions_limit - превышен лимит сессий на базовом устройстве
* * account_deivce_invalid - такое базовое устройство уже существует
* * external_api_error - ошибка запроса к внешней системе (например, к внешнему биллингу)
* * unknown_error - неизвестная ошибка (сопровождается stacktrace'ом)
* ``params`` - параметры запроса


account_device_error
++++++++++++++++++++

Ошибка при создании устройства аккаунта, контекст:

* ``account`` - аккаунт
* ``device`` - устройство
* ``device_uid`` - UID устройства
* ``client`` - оператор


4.1.3. smarty_billing_out - запросы к внешним системам
------------------------------------------------------

init_error
++++++++++

Ошибка инициализации обработчика API, контекст:

* ``kwargs`` - аргументы, переданные в класс обработчика
* ``api_client_class`` - название класса обработчика API
* stacktrace


customer_balance_request_error
++++++++++++++++++++++++++++++

Ошибка при запросе баланса, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* stacktrace


customer_balance_request_success
++++++++++++++++++++++++++++++++

Успешный запрос баланса, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* ``result`` - результат запроса


customer_payment_list_request_error
+++++++++++++++++++++++++++++++++++

Ошибка при запросе списка транзакций, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* stacktrace


customer_payment_list_request_success
+++++++++++++++++++++++++++++++++++++

Успешный запрос списка транзакций, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* result - результат запроса


video_actions_list_request_error
++++++++++++++++++++++++++++++++

Ошибка при запросе вариантов действий с видео, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* stacktrace


video_actions_list_request_success
++++++++++++++++++++++++++++++++++

Успешный запрос вариантов действий с видео, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* result - результат запроса


video_action_request_error
++++++++++++++++++++++++++

Ошибка при попытке произвести действие с видео, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* stacktrace


video_action_request_success
++++++++++++++++++++++++++++

Успешное действие с видео, контекст:

* ``api_client_class`` - название класса обработчика API
* ``params`` - параметры запроса
* result - результат запроса


4.1.4. smarty_billing_in - входящие запросы к Billing API
---------------------------------------------------------

billing_request_error
+++++++++++++++++++++

Ошибка при запросе к Billing API, контекст:

* ``url`` - URL метода, к которому производился запрос
* ``ip`` - IP-адрес, с которого производлися запрос
* ``args`` - аргументы запроса
* ``error_message`` - сообщение об ошибке
* ``error`` - код ошибки


billing_request_success
+++++++++++++++++++++++

Успешный запрос в биллинг, контекст:

* ``url`` - URL метода, к которому производился запрос
* ``ip`` - IP-адрес, с которого производлися запрос
* ``args`` - аргументы запроса


4.1.5. smarty_cache - события, связанные с кешированием
-------------------------------------------------------

object_cached
+++++++++++++

Обьект закеширован, контекст:

* ``object`` - кешируемый обьект
* ``timeout`` - время, по истечении которого обьект будет удален из кеша
* ``key`` - ключ обьекта в кеше
* ``deps`` - обьекты, при изменении которых кешируемый обьект должен быть инвалидирован


object_invalidated
++++++++++++++++++

Обьект инвалидирован, контекст:

* ``object`` -  обьект, который был удален из кеша
* ``deps_key`` - ключ обьекта, где находятся ключи связанных обьектов, которые тоже должны быть инвалидированы


4.1.6. smarty_messaging - лог отправленных сообщений для аккаунтов
------------------------------------------------------------------

message_created
+++++++++++++++

Создано сообщение, контекст:

* ``account`` - аккаунт, которому было отправлено сообщение
* ``subject`` - тема сообщения
* ``text`` - текст сообщения


message_send
++++++++++++

Сообщение отправлено, контекст:

* ``account`` - аккаунт, которому было отправлено сообщение
* ``subject`` - тема сообщения
* ``text`` - текст сообщения
* ``uuid`` - идентификатор сообщения


message_deleted
+++++++++++++++

Сообщение удалено, дополнительный контекст:

* ``account`` - аккаунт, которому было отправлено сообщение
* ``subject`` - тема сообщения
* ``text`` - текст сообщения
* ``uuid`` - идентификатор сообщения


4.1.7. smarty_management - лог периодических команд
---------------------------------------------------

management_command_success
++++++++++++++++++++++++++

Успешное выполнение команды, дополнительный контекст:

* ``command`` - название команды
* ``execution_time`` - время выполнения


management_command_error
++++++++++++++++++++++++

Ошибка выполнения команды, дополнительный контекст:

* ``command`` - название команды
* stacktrace


4.1.8. smarty_epg - лог импорта EPG
-----------------------------------

epg_channel_imported
++++++++++++++++++++

Программы для канала успешно импортированы, дополнительный контекст:

* ``epg_channel`` - канал
* ``source`` - источник EPG
* ``programs_imported`` - количество импортированных программ


epg_channel_import_error
++++++++++++++++++++++++

Ошибка при импорте программ, дополнительный контекст:

* ``epg_channel`` - канал
* ``source`` - источник EPG
* stacktrace


epg_import_finished
+++++++++++++++++++

Импорт программ завершен, дополнительный контекст:

* ``channels_processed`` - количество обработанных каналов
* ``programms_imported`` - количество импортированных программ


4.1.9. smarty_content_requests - запросы на получение ссылки/адреса потока через TVMW API
-----------------------------------------------------------------------------------------

content_request_fail
++++++++++++++++++++

Произошла необработанная ошибка в процессе запроса, необходимо обратиться к разработчику.

Дополнительный контекст:

* ``url``  - URL метода, к которому производился запрос
* ``params`` - параметры запроса
* stacktrace

content_request_error
+++++++++++++++++++++

Обработанная ошибка в процессе запроса, дополнительный контекст:

* ``url``  - URL метода, к которому производился запрос
* ``params`` - параметры запроса

Возможные причины:

* неверные параметры запроса
* устаревший ключ авторизации
* запрос к устравшем данным (например, попытка воспроизвести слишком старую передачу из архива)


content_request_success
+++++++++++++++++++++++

Успешный запрос, ссылка получена, дополнительный контекст:

* ``url`` - URL метода, к которому производился запрос
* ``params`` - параметры запроса
* дополнительная информация, в т.ч. адрес потока (в зависимости от метода)


client_channels_not_found
+++++++++++++++++++++++++

В кеше не обнаружены каналы для данного Client ID,
возможно был сброшен кеш или произошла ошибка выполнения команды ``cache_channel_list``, дополнительный контекст:

* ``client`` - Client ID


4.1.10. smarty_portal - лог событий портала
-------------------------------------------

portal_event
++++++++++++

Событие в портале, дополнительный контекст:

* ``event_description`` - описание события
* ``ip`` - IP-адрес устройства абонента
* ``device_uid`` - идентификатор устройства
* ``screen_name`` - название экрана
* ``user_agent`` - User-Agent устройства


4.1.11. smarty_stream_services - лог стриминг-сервисов
-------------------------------------------------------

stream_service_checking_error
+++++++++++++++++++++++++++++

Ошибка при проверке доступности стриминг-сервиса, дополнительный контекст:

* ``stream_service`` - стриминг-сервис
* ``was_available_before`` - указывает, был ли стриминг-сервис доступен ранее
* ``check_ping_success`` - была ли успешной проверка пингом (опционально)
* ``check_tcp_success``- была ли успешной проверка попыткой открыть сокет (опционально) 
* ``check_http_success`` - была ли успешной проверка попыткой открыть URL (опционально)
* ``check_is_alive_success`` - была ли успешной проверка is_alive (опционально)
* stacktrace


stream_service_checking_success
+++++++++++++++++++++++++++++++

Успешная проверка доступности стриминг-сервиса, дополнительный контекст:

* ``stream_service`` - стриминг-сервис
* ``was_available_before`` - указывает, был ли стриминг-сервис доступен ранее
* ``check_ping_success`` - проверка пингом была успешной (опционально)
* ``check_tcp_success``- проверка попыткой открыть сокет была успешной (опционально) 
* ``check_http_success`` - проверка попыткой открыть URL была успешной (опционально)
* ``check_is_alive_success`` - проверка is_alive была успешной (опционально)



4.1.12. smarty_admin - лог панели администрирования Smarty
----------------------------------------------------------

admin_request
+++++++++++++

Запрос к административному интерфейсу, дополнительный контекст:

* ``user`` - пользователь, осуществивший запрос
* ``ip`` - IP пользовтаеля
* ``path`` - путь запроса
* ``user_agent`` - User-Agent браузера

    

