.. _portal_setup:

***************************************************
6. Установка и настройка портала для STB и Smart TV
***************************************************

Портал - это набор Javascript-приложений (JS/HTML/CSS) в разных стилевых и функциональных вариантах (шаблонов), представляющих
собой оболочку (интерфейс) для абонента. Портал загружается встроенным в устройство (приставку или Smart TV) браузером.

6.1. Установка портала
======================

Поскольку портал это статические файлы, не требующие сервера приложений с поддержкой выполнения каких-либо скриптов, то
для его хостинга достаточно любого веб-сервера. Также, при необходимости, портал может быть размещен на CDN-сервисе
или встроен в прошивку устройства.

С сервером Smarty портал взаимодействует через HTTP API посредством выполнения XMLHttpRequest-запросов.

Для хостинга портала рекомендуется использовать веб-сервер nginx.

Настройки портала задаются в файле ``client.js``, размещенном в корневой директории. Для удобства деплоя и администрирования
client.js, обычно, является симлинком на специфичный для данного провайдера конфиг, размещенный в ``/etc/microimpuls/portal/``.

.. note::

    Из-за политики ограничения выполнения кроссдоменных запросов на некоторых устройствах рекомендуется для выполнения
    запросов к Smarty использовать тот же домен, где размещен портал. В стандартном конфиге nginx для портала, который
    идет в комплекте с установочным пакетом портала, указан специальный location /api, осуществляющий редирект на
    Smarty.

.. _client_js_options:

6.2. Параметры конфигурации client.js
=====================================

В конфиге client.js задаются как основные параметры (например, данные для подключения к Smarty), так и специфичные
для каждого приложения (шаблона).

.. _client_js_main_options:

Обязательные параметры
++++++++++++++++++++++

Актуальная документация по обязательным параметрам: https://microimpuls.com/docs/smarty/portal-and-apps-settings/portal-settings


.. _client_js_additional_options:

Дополнительные параметры
++++++++++++++++++++++++

Актуальная документация по дополнительным параметрам: https://microimpuls.com/docs/smarty/portal-and-apps-settings/portal-settings

.. _client_js_specific_options:

Специфичные для шаблонов параметры
++++++++++++++++++++++++++++++++++

Актуальная документация по дополнительным параметрам шаблона impuls: https://microimpuls.com/docs/smarty/portal-and-apps-settings/impuls-settings

Актуальная документация по дополнительным параметрам шаблона focus: https://microimpuls.com/docs/smarty/portal-and-apps-settings/focus-settings


registration_available ``bool``
    Показывать или нет кнопку и экран регистрации через СМС.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

auth_mode ``str``
    Режим авторизации устройства. Возможные значения:
    *abonement* - только по логину, без пароля (реализовано только для шаблона ``focus``);
    *password* - по логину и паролю (по умолчанию);
    *device_uid* - по уникальному идентификатору устройства (обычно MAC-адресу) или по IP-адресу.
    В случае неуспешной авторизации абоненту будет предложена авторизация по логину и паролю.
    *device_uid_wo_fallback* - то же самое, что *device_uid*, но без обработки некоторых ситуаций
    неуспешной авторизации и перехода на авторизацию по логину и паролю.
    Поддерживается только в шаблонах: ``impuls``, ``focus``, ``futuristic``, ``infinitly``.

server_rewind_mode ``bool``
    Режим перемотки плеера. При значении *true* при перемотке будет использоваться позиционирование с помощью указания
    временной метки видео-серверу с перезапросом видеопотока. При значении *false* - перемотка по потоку методом seek
    средствами плеера (работает не всегда корректно из-за различной реализации на плеерах, однако быстрее).
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``focus``, ``futuristic``.

samsung_guidelines_compatibility_mode ``bool``
    Включить или нет режим соблюдения гайдлайнов Samsung (используется для включения некоторых специальных ограничений
    для более простой публикации в маркеты Samsung Apps, LG Apps и Google Play). Опция влияет на следующие механизмы:
    
    * навигация между экранами - кнопка Back всегда ведет на предыдущий экран;
    * выход из приложения - кнопка Exit закрывает приложение, кнопка Back в главном экране и на экране авторизации закрывает приложение;
    * всплывающее окно перед закрытием приложения - перед тем, как приложение закрывается, показывается попап-окно с подтверждением закрытия;
    * радио не проигрывается в фоне на LG.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``, ``infinitly``, ``classic``, ``focus``.

auto_launch_last_viewed_channel ``bool``
    Значение по умолчанию для опции, задаваемой абонентом - "Воспроизводить последний просматриваемый канал"
    автоматически при запуске приложения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

is_letters_in_password ``bool``
    Разрешено ли использовать буквы в пароле в экранной клавиатуре при авторизации.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``, ``infinitly``.

vod_show_news ``bool``
    Показывать ли категорию видеотеки "Новинки".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``, ``infinitly``.

vod_show_packages ``bool``
    Показывать ли категорию видеотеки "Пакеты фильмов".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

vod_show_purchased ``bool``
    Показывать ли категорию видеотеки "Купленное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

vod_show_viewed ``bool``
    Показывать ли категорию видеотеки "Просмотренное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

show_logout_option ``bool``
    Показывать ли кнопку и возможность логаута в экране профиля.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

show_main_menu_on_first_launch ``bool``
    Показывать ли главное меню после загрузки портала. Если *false*, то будет открыт экран плеера.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

navigation_mode ``str``
    Режим навигации в приложении, возможные значения:
    *normal* - обычная навигация;
    *horizontal* - переход между экранами стрелками пульта.
    По умолчанию *normal*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

disable_set_button_on_mag ``bool``
    При значении *true* кнопка **Setup** на пульте приставки MAG будет заблокирована.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

restore_login_form_inputs_from_settings ``bool``
    Отображать ли значения полей "Логин" и "Пароль" в форме авторизации при перезапуске приложения.
    При методе авторизации *password* рекомендуется использовать эту опцию.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

tv_channels_list_mode ``str``
    Режим отображения списка каналов. Возможные значения для шаблона ``futuristic``:
    *list* - список по умолчанию;
    *grid* - сетка;
    *longlist* - длинный список (10 каналов на страницу вместо 5).
    Возможные значения для шаблона ``impuls``:
    *list* - список по умолчанию;
    *preview* - с окном предпросмотра (плеером).
    По умолчанию *list*.
    Поддерживается только в шаблонах: ``futuristic``, ``impuls``.

allow_to_change_tv_channels_list_mode ``bool``
    Разрешить ли абоненту изменять режим отображения каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

custom_body_class ``str``
    Подключить дополнительный класс к тегу body портала.
    По умолчанию *не задан*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

reboot_device_after_login_with_password ``bool``
    При значении *true* после авторизации абонента логином и паролем через форму авторизации произойдет перезагрузка
    устройства. Может быть использовано для выполнения системных операций биллинга при первичной "активации" приставки
    абонентом.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

show_number_of_channels_in_all_category ``bool``
    При значении *true* в разделе "ТВ" в названии категории "Все каналы" будет добавлено отображения количества
    телеканалов в этой категории.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

player_rewind_step ``int``
    Шаг перемотки плеера в секундах, в режиме архива и VOD. По умолчанию 30 секунд.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``, ``infinitly``.

allow_to_change_data_center ``bool``
    При значении *true* в настройках абонента появится возможность изменения дата-центра (сервера вещания).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_balance_menu ``bool``
    При значении *true* будет отображаться меню "Баланс".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

show_messages_menu ``bool``
    При значении *true* будет отображаться меню "Сообщения".
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

switching_channels_inside_category ``bool``
    При значении *true* переключение каналов кнопками CH+/CH- будет происходить внутри выбранной категории каналов,
    а не в полном списке каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

main_screen_mode ``str``
    Режим отображения главного меню портала. Возможные значения для шаблона ``futuristic``:
    *classic_menu* - стандартное меню с виджетами;
    *showcase* - витрина с контентом, виджетами, приложениями и меню.
    По умолчанию ``classic_menu``.
    Поддерживается только в шаблонах: ``futuristic``.

allow_to_change_main_screen_mode ``bool``
    При значении *true* при нажатии желтой кнопки в главное меню будет изменяться режим *main_screen_mode*.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

tv_show_favorites ``bool``
    При значении *true* в шаблоне для экрана "ТВ" будет включена категория "Избранное".
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

check_account_template ``bool``
    При значении *true* после авторизации акканта будет осуществляться проверка шаблона, установленного в настройках аккаунта в Smarty,
    и если он отличается от используемого приложение будет перезагружено в нужном шаблоне.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

save_aspect_ratio_per_channel ``bool``
    При значении *true* в настройках портала на устройстве выбранное соотношение сторон будет сохраняться отдельно
    для каждого канала, при значении *false* - общее значение для всех каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

save_audio_track_lang_per_channel ``bool``
    При значении *true* в настройках портала на устройстве выбранный язык аудио-дорожки будет сохраняться отдельно
    для каждого канала, при значении *false* - выбранный по умолчанию язык аудио будет одинаковым для всех каналов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

filter_videos_by_genres ``bool``
    При значении *true* в экране кинотеатра фильмы группируются по жанрам.
    При значении *false* в экране кинотеатра фильмы группируются по жанрам-категориям.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``infinitly``.

samsung_smart_tv_volume_control_off ``bool``
    Флаг для отключения управления звуком на уровне приложения для устройств Samsung Smart TV под Orsay.
    При значении *false* управление звуком осуществляется на уровне приложения.
    При значении *true* управление звуком осуществляется на уровне системы (стандартное управление внутри телевизора).
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_mode ``str``
    Настройка для выбора режима видеотеки. Возможные значения:
    *classic* - отображение видеотеки по умолчанию (списком).
    *showcase* - отображение видеотеки в режиме "Витрина".
    По умолчанию *classic*.
    Поддерживается только в шаблонах: ``futuristic``.

save_last_tvcategory ``bool``
    Флаг для установки последней просматриваемой категории при запуске приложения.
    При значении *false* будет открываться категория "Все".
    При значении *true* будет открываться та категория, которая была открыта перед закрытием приложения.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

epg_list_mode ``str``
    Режим отображения списка программы передач.
    При значении *list* отображается список по умолчанию.
    При значении *longlist* отображается длинный список без дополнительной информации о каждой передаче.
    По умолчанию *list*.
    Поддерживается только в шаблонах: ``futuristic``.

show_media_portal_service_on_mag ``bool``
    Флаг для отображения медиа-портала на приставках mag.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

open_sort_from_tv ``bool``
    Флаг для включения быстрого перехода к экрану «Сортировка каналов» из экрана «ТВ».
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

vod_list_mode ``str``
    Режим отображения списка фильмов в видеотеке.
    При значении *grid* отображается стандартная сетка фильмов в постерами.
    При значении *longlist* отображается длинный список фильмов без постеров.
    По умолчанию *grid*.
    Поддерживается только в шаблонах: ``futuristic``.

switch_channels_in_preview_mode ``bool``
    Флаг, который при каждом переключении канала в экране "Телеканалы" в режиме preview запускает выделенный канал в
    масштабированном окне плеера.
    При значении *false* во время переключения канала меняется только описание под плеером.
    При значении *true* во время переключения канала обновляется и проигрываемый канал.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

use_remote_button_back_as_backspace_in_virtual_keyboard ``bool``
    Флаг, который меняет поведение кнопки Back во время отображения экранной клавиатуры.
    При значении *false* кнопка Back закрывает экранную клавиатуру.
    При значении *true* кнопка Back работает как Backspace.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

enable_instant_search_for_vod ``bool``
    Флаг, включающий режим поиска фильмов по мере ввода символов.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

stop_player_on_screen_showing ``bool``
    Флаг, включающий режим остановки плеера при переходе на другой экран.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

show_help_button_panel ``bool``
    Флаг для отображения вспомогательной панели с кнопками (необходима для пультов с урезанным набором кнопок).
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

block_requests_in_standby ``bool``
    Включает блокировку запросов к серверу, если устройство находится в режиме Stand-By.
    После выхода из Stand-By отправка запросов к серверу восстанавливается, однако данные в интерфейсе могут быть
    устаревшими в течение некоторого времени.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

vod_show_favorited ``bool``
    Флаг, отвечающий за отображение категории "Избранное" в экране VOD.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``focus``, ``futuristic``, ``infinitly``.

vod_show_all ``bool``
    Флаг, отвечающий за отображение категории "Все" в экране VOD.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

allow_to_change_access_restriction_for_purchase_content ``bool``
    Флаг, который добавляет в список настроек пункт для изменения доступа к покупкам.
    По умолчанию *true*.
    Поддерживается только в шаблонах: ``futuristic``.

show_payment_menu ``bool``
    Флаг, который добавляет в список экрана "Мой профиль" пункт оплаты.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

epg_hide_zero_plus_rating ``bool``
    Флаг, который скрывает для передач с рейтингом 0+ их рейтинг.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

default_purchase_content_access_mode ``str``
    Значение по умолчанию для пункта настроек для изменения доступа покупкам.
    При значении *pin* по умолчанию выставляется пункт "Оплата контента с пин-кодом".
    При значении *allow* по умолчанию выставляется пункт "Оплата контента без пин-кода".
    По умолчанию *allow*.
    Поддерживается только в шаблонах: ``futuristic``.

show_tv_menu_and_play_first_channel_on_first_launch ``bool``
    Флаг, который при первом запуске приложения открывает список телеканалов и запускает первый по списку канал.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

monitoring_interval_sys_info ``int``
    Периодичность (в миллисекундах), с которой портал будет отправлять системные метрики с устройства на сервер Smarty MVision.
    Отправка метрик должна быть также включена в настройках устройства в панели администратора Smarty.
    По умолчанию *300000*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

monitoring_interval_metrics ``int``
    Периодичность (в миллисекундах), с которой портал будет отправлять метрики производительности и качества видео с устройства на сервер Smarty MVision.
    Отправка метрик должна быть также включена в настройках устройства в панели администратора Smarty.
    По умолчанию *15000*.
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.
    
monitoring_server_url ``str``
    Адрес MVision-сервера для отправки статистики, указывается в случае, если MVision и Smarty находятся на разных серверах. Если значение опции не указано, то статистика отправляется в Smarty.
    По умолчанию *не задано*
    Поддерживается только в шаблонах: ``impuls``, ``futuristic``.

autohide_timer ``number``
    Тайм-аут (в минутах), по истечению которого должен быть скрыт текущий экран и открыт экран плеера, если в настоящий
    момент есть воспроизведение какого-то контента.
    По умолчанию *0*.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

registration_phone_mask ``str``
    Маска номера мобильного телефона, используемая в поле регистрации абонента.
    По умолчанию *+7 ??? ??? ?? ??*.
    Поддерживается только специальный символ *?*, вместо которого будет подставляться вводимое значение, остальные
    символы будут отображены как есть.
    Поддерживается только в шаблонах: ``futuristic``.

loading_timeout ``int``
    Количество миллисекунд, на которое будет задержана первоначальная загрузка портала. Может быть использовано, например,
    для кастомизации портала, чтобы перед запуском отобразить приветственную картинку.
    По умолчанию 1.
    Поддерживается только в шаблонах: ``futuristic``.

max_epg_depth ``int``
    Определяет глубину EPG в днях для экрана "Телепрограмма".
    Если опция больше 0, то глубина будет равна значению опции. Если опция не задана (равна 0): для канала с архивом будет использована глубина архива (поле max_archive_duration канала), если у канала нет архива - программа передач будет отображаться только за текущий день.
    По умолчанию 0.
    Поддерживается только в шаблонах: ``futuristic``, ``infinitly``.

template_styles ``array``
    Список доступных для абонента стилей оформления шаблона (прописывается отдельно для каждого шаблона). Изменить стиль можно в экране настроек. Стиль оформления никак не влияет на функционал шаблона.
    По умолчанию *{}*
    Поддерживается только в шаблонах: ``futuristic``.

template_style ``str``
    Имя стиля оформления шаблона, используемое по дефолту.
    По умолчанию *не задано*.
    Поддерживается только в шаблонах: ``futuristic``.
    Доступные значения для шаблона ``futuristic``:
    *futuristic_x* - минималистичный стиль оформления.

switch_channels_by_up_down_keys ``bool``
    Флаг, который позволяет перелистывать каналы в полноэкранном режиме плеера с помощью кнопок вверх-вниз.
    По умолчанию *false*.
    Поддерживается только в шаблонах: ``futuristic``.

.. _portal_event_system:

6.3. Механизм событий
=====================

События позволяют добавлять или переопределять некоторый функционал портала в разные моменты его жизненного цикла.
Обработчики событий задаются в конфиге client.js, что позволяет сохранить кастомные настройки и функции даже при обновлении
портала на новую версию.

Доступные события:

* *OnDataRequestError* - ошибка выполнения запроса к Smarty, в качестве аргумента - код ошибки
* *OnAppInitBegin* - старт инициализации приложения
* *OnAppInitEnd* - завершение инициализации приложения
* *OnDeviceInitBegin* - старт инициализации драйвера устройства
* *OnDeviceInitEnd* - завершение инициализации драйвера устройства
* *OnDeviceKeyEvent* - событие нажатия клавиши пульта, в качестве аргумента - код клавиши
* *OnAccountLoginSuccessful* - успешная авторизация аккаунта

Жизненный цикл: *OnAppInitBegin > OnDeviceInitBegin > OnDeviceInitEnd > OnAppInitEnd*.

Пример создания обработчиков событий приведен ниже.

.. note::

    Внимание! Использование этого механизма требует навыков программирования на Javascript, знания архитектуры и API портала и API устройств.

6.4. Пример конфигурации
========================

Пример ниже предназначен для шаблона ``impuls`` и кроме стандартного поведения добавляет дополнительный пункт в меню
настроек абонента - "Режим ожидания", включающий или отключающий обработку событий подключения/отключения HDMI-кабеля
на приставке MAG, а также проверяет версию прошивки и запускает обновление в случае необходимости при старте
приложения и добавляет некоторые другие функции. ::

    var CLIENT_SETTINGS = {
        'client_id': 1,
        'api_key': '***',
        'api_url': '/api',
        'template_name': 'impuls',
        'template_size': {
            'impuls': {
                'default': [1280, 720]
            },
            'classic': {
                'default': [1280, 720],
                '720x576': [720, 576]
            },
        },
        'available_templates': ['futuristic'],
        'template_styles': {
            'futuristic': ['futuristic', 'futuristic_x']
        },
        'settings_filename': 'example.dat',
        'site_url': 'www.example.com',
        'signup_auto_activation_period': 0,
        'show_welcome_message': false,1
        'registration_available': false,
        'settings_menu_custom_items': [
            'handle-hdmi-events'
        ],
        'auth_mode': 'device_uid',
        'default_timezone': 12,
        'default_buffersize': 3,
    };

    OnAppInitBegin = function()
    {
        // Автоматическое выключение плеера ночью в 01:30 по локальному времени
        setInterval(function(){
            var date = new Date();
            if (date.getHours() == 1 && date.getMinutes() == 30) {
                App.player.stop();
                App.display.showScreen('tvchannels');
            }
        }, 35000);

        // Обновление прошивки для определенных старых версий
        try {
            var fver = parseInt(gSTB.RDir('ImageVersion'));
            var desc = gSTB.GetDeviceImageDesc();
            if (desc == 'default-214') {
                stbUpdate.startAutoUpdate("http://update.example.com/imageupdate", true);
            }
        } catch (e) {}
    };

    OnAppInitEnd = function()
    {
        // Подключение custom css верстки
        var el = document.createElement('link');
        el.rel = 'stylesheet';
        el.type = 'text/css';
        el.href = '/custom/css/custom.css';
        document.getElementsByTagName('body')[0].appendChild(el);

        // Подключение режима overscan для шаблона impuls
        Helper.addBodyClass('overscan');

        // Переопределение кнопки EPG на красную кнопку
        App.playerScreen.key_epg = App.playerScreen.key_red;
        App.tvChannelsScreen.key_epg = App.tvChannelsScreen.key_red;

        // Переопределение обработчика кнопки Power
        App.display.setGlobalKeyCodeHandler('power', function(){
            App.player.stop();
            App.display.showScreen('mainmenu');
        }, App.playerScreen);
    };

    OnDeviceInitBegin = function()
    {
        // Добавление меню настройки режима ожидания
        var handleHdmiEventsMenu = new BaseMenu({
            menuTag: 'ul',
            itemIdPrefix: 'settings-handle-hdmi-events-value',
            useItemIdWithoutIndex: true,
            itemTag: 'span',
            displayItemsNumber: 1,
            sourceItemsNumber: 2,
            useFastRefresh: false,
            getItemNameFunc: function(sourceItemIndex, displayItemIndex) {
                var names = [
                    'Отключен',
                    'Включен'
                ];
                return names[sourceItemIndex];
            }
        });
        App.settings.setCustomSetting('handle-hdmi-events', 1);
        App.lang.set('ru', 'label-settings-handle-hdmi-events', 'Режим ожидания');
        App.settingsScreen.addCustomSettingsMenu('handle-hdmi-events', handleHdmiEventsMenu);
    };

    OnDeviceInitEnd = function()
    {
        // Установка произвольной прозрачности интерфейса
        App.device.setWindowTransparencyLevel(230);

        // Установка режима 16:9 по умолчанию
        App.device.setAspectRatioMode('16:9');

        // Обработка событий HDMI для MAG
        if (App.device.getDeviceKind() === 'mag') {
            App.device.standBy = false;
            App.device.standByTimer = null;
            App.device.onEvent = function(code) {
                switch (code) {
                    default:
                        break;
                    case 0x20: // HDMI connected
                        if (Helper.toInt(App.settings.getCustomSetting('handle-hdmi-events')) == 1) {
                            clearTimeout(App.device.standByTimer);
                            if (App.device.standBy) {
                                App.device.stb.StandBy(false);
                                App.device.standBy = false;
                            }
                        }
                        break;
                    case 0x21: // HDMI disconnected
                        if (Helper.toInt(App.settings.getCustomSetting('handle-hdmi-events')) == 1) {
                            clearTimeout(App.device.standByTimer);
                            App.device.standByTimer = setTimeout(function () {
                                if (!App.device.standBy) {
                                    if (App.player.isActive()) {
                                        App.player.stop();
                                        App.display.showScreen('tvchannels');
                                    }
                                    App.device.stb.StandBy(true);
                                    App.device.standBy = true;
                                }
                            }, 60 * 5 * 1000);
                        }
                        break;
                }
            }
        }
    };

    OnAccountLoginSuccessful = function()
    {
        // Изменение формата отображения оставшихся дней активации на dd/mm/yyyy
        var value = App.data.getActivationDaysLeft();
        if (parseInt(value) <= 0) {
            value = App.lang.get('auto-renewal');
        } else {
            var d = new Date(new Date().getTime()+(parseInt(value)*24*60*60*1000));
            var dd = d.getDate();
            var mm = d.getMonth() + 1;
            var y = d.getFullYear();
            value = dd + '/' + mm + '/' + y;
        }
        Helper.setHtml('info-menu-activation-days-left', value);
    };

6.5 Кастомизация стилей оформления портала
==========================================

Smarty позволяет для каждого устройства задать внешний css-файл для кастомного оформления портала, например, установить
своё фоновое изображение, сменить цвет шрифта или фокуса.

Для этого необходимо открыть в панели администрирования "Общие настройки" -> "Настройки STB и приложений" ->
<устройство для настройки> и прописать в поле "Внешний CSS" путь до файла с новыми стилями. Как правило, данный файл
располагают на том же веб-сервере, что и портал.

Для создания файла с внешними стилями достаточно с помощью отладчика любого браузера проследить какие классы и
идентификаторы отвечают за тот или иной элемент экрана в портале, после чего перезаписать/дописать нужные свойства к ним.
Ниже представлены самые часто встречающиеся примеры кастомизации для шаблонов ``futuristic`` и ``impuls``.

Пример внешнего css-файла для кастомизации шаблона ``futuristic``. ::

    /* Установка кастомного фонового изображения */

    .screen, .android_stb .screen {
        background: url('example-bg.jpg') no-repeat;
    }

    /* Установка кастомного фонового изображения для верхней панели с лого оператора */

    #statusbar-screen {
        background: transparent url('statusbar-bg.png') no-repeat;
    }

    /* Установка кастомного изображения для фокуса главного меню  */

    div#main-menu-selection {
        background: transparent url('example-selection-bg.png') no-repeat center 0px;
    }

Пример внешнего css-файла для кастомизации шаблона ``impuls``. ::

    /* Установка кастомного лоадера */

    .screen-container.loader, #player-mode-icon.loader, #loading-bar {
        background: transparent url("loader-example.gif") center center no-repeat;
    }

    #firstloading-loader {
        background: url('loader-example.gif') no-repeat;
        height: 65px;
        width: 120px;
    }

    .loader#video-actions-panel {
        background: transparent url("loader-example.gif") center left no-repeat;
        height: 120px;
    }

    /* Установка кастомного фонового изображения */

    .screen, body, .play .screen, .png-transparency .screen, .play.png-transparency .screen,
    .transparent.png-transparency .screen, .transparent .screen {
        background: url('example-bg.jpg') no-repeat;
    }

    body.play {
        background: transparent;
    }

    /* Установка кастомных координат для логотипа оператора */

    .client-logo {
        margin-top: 75px !important;
        margin-right: 30px;
    }

.. note::

    Нужно учесть, что для корректной работы внешних стилей, необходимо, чтобы все дополнительные ресурсы (изображения,
    шрифты), используемые в них, были доступны и имели правильные пути.

.. note::
    После установки обновлений шаблонов необходимо внимательно читать changelog и тщательно тестировать портал на
    предмет корректности работы внешнего CSS, так как внутренние css- и html-файлы могут претерпевать изменения, что
    так или иначе влияет на отображение кастомных стилей.


